{"ast":null,"code":"//\n//\n//\n\n// General-purpose API for glueing everything together.\n\n'use strict';\n\nvar URL = require('url');\nvar QS = require('querystring');\nvar Connection = require('./connection').Connection;\nvar fmt = require('util').format;\nvar credentials = require('./credentials');\nfunction copyInto(obj, target) {\n  var keys = Object.keys(obj);\n  var i = keys.length;\n  while (i--) {\n    var k = keys[i];\n    target[k] = obj[k];\n  }\n  return target;\n}\n\n// Adapted from util._extend, which is too fringe to use.\nfunction clone(obj) {\n  return copyInto(obj, {});\n}\nvar CLIENT_PROPERTIES = {\n  \"product\": \"amqplib\",\n  \"version\": require('../package.json').version,\n  \"platform\": fmt('Node.JS %s', process.version),\n  \"information\": \"http://squaremo.github.io/amqp.node\",\n  \"capabilities\": {\n    \"publisher_confirms\": true,\n    \"exchange_exchange_bindings\": true,\n    \"basic.nack\": true,\n    \"consumer_cancel_notify\": true,\n    \"connection.blocked\": true,\n    \"authentication_failure_close\": true\n  }\n};\n\n// Construct the main frames used in the opening handshake\nfunction openFrames(vhost, query, credentials, extraClientProperties) {\n  if (!vhost) vhost = '/';else vhost = QS.unescape(vhost);\n  var query = query || {};\n  function intOrDefault(val, def) {\n    return val === undefined ? def : parseInt(val);\n  }\n  var clientProperties = Object.create(CLIENT_PROPERTIES);\n  return {\n    // start-ok\n    'clientProperties': copyInto(extraClientProperties, clientProperties),\n    'mechanism': credentials.mechanism,\n    'response': credentials.response(),\n    'locale': query.locale || 'en_US',\n    // tune-ok\n    'channelMax': intOrDefault(query.channelMax, 0),\n    'frameMax': intOrDefault(query.frameMax, 0x1000),\n    'heartbeat': intOrDefault(query.heartbeat, 0),\n    // open\n    'virtualHost': vhost,\n    'capabilities': '',\n    'insist': 0\n  };\n}\n\n// Decide on credentials based on what we're supplied\nfunction credentialsFromUrl(parts) {\n  var user = 'guest',\n    passwd = 'guest';\n  if (parts.auth) {\n    var auth = parts.auth.split(':');\n    user = auth[0];\n    passwd = auth[1];\n  }\n  return credentials.plain(user, passwd);\n}\nfunction connect(url, socketOptions, openCallback) {\n  // tls.connect uses `util._extend()` on the options given it, which\n  // copies only properties mentioned in `Object.keys()`, when\n  // processing the options. So I have to make copies too, rather\n  // than using `Object.create()`.\n  var sockopts = clone(socketOptions || {});\n  url = url || 'amqp://localhost';\n  var noDelay = !!sockopts.noDelay;\n  var timeout = sockopts.timeout;\n  var keepAlive = !!sockopts.keepAlive;\n  // 0 is default for node\n  var keepAliveDelay = sockopts.keepAliveDelay || 0;\n  var extraClientProperties = sockopts.clientProperties || {};\n  var protocol, fields;\n  if (typeof url === 'object') {\n    protocol = (url.protocol || 'amqp') + ':';\n    sockopts.host = url.hostname;\n    sockopts.port = url.port || (protocol === 'amqp:' ? 5672 : 5671);\n    var user, pass;\n    if (!url.username) {\n      user = 'guest';\n      pass = url.password || 'guest';\n    } else {\n      user = url.username;\n      pass = url.password;\n    }\n    fields = openFrames(url.vhost, null, sockopts.credentials || credentials.plain(user, pass), extraClientProperties);\n  } else {\n    var parts = URL.parse(url, true); // yes, parse the query string\n    protocol = parts.protocol;\n    sockopts.host = parts.hostname;\n    sockopts.port = parseInt(parts.port) || (protocol === 'amqp:' ? 5672 : 5671);\n    var vhost = parts.pathname ? parts.pathname.substr(1) : null;\n    fields = openFrames(vhost, parts.query, sockopts.credentials || credentialsFromUrl(parts), extraClientProperties);\n  }\n  var sockok = false;\n  var sock;\n  function onConnect() {\n    sockok = true;\n    sock.setNoDelay(noDelay);\n    if (keepAlive) sock.setKeepAlive(keepAlive, keepAliveDelay);\n    var c = new Connection(sock);\n    c.open(fields, function (err, ok) {\n      // disable timeout once the connection is open, we don't want\n      // it fouling things\n      if (timeout) sock.setTimeout(0);\n      if (err === null) {\n        openCallback(null, c);\n      } else openCallback(err);\n    });\n  }\n  if (protocol === 'amqp:') {\n    sock = require('net').connect(sockopts, onConnect);\n  } else if (protocol === 'amqps:') {\n    sock = require('tls').connect(sockopts, onConnect);\n  } else {\n    throw new Error(\"Expected amqp: or amqps: as the protocol; got \" + protocol);\n  }\n  if (timeout) {\n    sock.setTimeout(timeout, openCallback.bind(this, new Error('connect ETIMEDOUT')));\n  }\n  sock.once('error', function (err) {\n    if (!sockok) openCallback(err);\n  });\n}\nmodule.exports.connect = connect;","map":{"version":3,"names":["URL","require","QS","Connection","fmt","format","credentials","copyInto","obj","target","keys","Object","i","length","k","clone","CLIENT_PROPERTIES","version","process","openFrames","vhost","query","extraClientProperties","unescape","intOrDefault","val","def","undefined","parseInt","clientProperties","create","mechanism","response","locale","channelMax","frameMax","heartbeat","credentialsFromUrl","parts","user","passwd","auth","split","plain","connect","url","socketOptions","openCallback","sockopts","noDelay","timeout","keepAlive","keepAliveDelay","protocol","fields","host","hostname","port","pass","username","password","parse","pathname","substr","sockok","sock","onConnect","setNoDelay","setKeepAlive","c","open","err","ok","setTimeout","Error","bind","once","module","exports"],"sources":["/home/jp228/node_modules/amqp-ts/node_modules/amqplib/lib/connect.js"],"sourcesContent":["//\n//\n//\n\n// General-purpose API for glueing everything together.\n\n'use strict';\n\nvar URL = require('url');\nvar QS = require('querystring');\nvar Connection = require('./connection').Connection;\nvar fmt = require('util').format;\nvar credentials = require('./credentials');\n\nfunction copyInto(obj, target) {\n  var keys = Object.keys(obj);\n  var i = keys.length;\n  while (i--) {\n    var k = keys[i];\n    target[k] = obj[k];\n  }\n  return target;\n}\n\n// Adapted from util._extend, which is too fringe to use.\nfunction clone(obj) {\n  return copyInto(obj, {});\n}\n\nvar CLIENT_PROPERTIES = {\n  \"product\": \"amqplib\",\n  \"version\": require('../package.json').version,\n  \"platform\": fmt('Node.JS %s', process.version),\n  \"information\": \"http://squaremo.github.io/amqp.node\",\n  \"capabilities\": {\n    \"publisher_confirms\": true,\n    \"exchange_exchange_bindings\": true,\n    \"basic.nack\": true,\n    \"consumer_cancel_notify\": true,\n    \"connection.blocked\": true,\n    \"authentication_failure_close\": true\n  }\n};\n\n// Construct the main frames used in the opening handshake\nfunction openFrames(vhost, query, credentials, extraClientProperties) {\n  if (!vhost)\n    vhost = '/';\n  else\n    vhost = QS.unescape(vhost);\n\n  var query = query || {};\n\n  function intOrDefault(val, def) {\n    return (val === undefined) ? def : parseInt(val);\n  }\n\n  var clientProperties = Object.create(CLIENT_PROPERTIES);\n\n  return {\n    // start-ok\n    'clientProperties': copyInto(extraClientProperties, clientProperties),\n    'mechanism': credentials.mechanism,\n    'response': credentials.response(),\n    'locale': query.locale || 'en_US',\n\n    // tune-ok\n    'channelMax': intOrDefault(query.channelMax, 0),\n    'frameMax': intOrDefault(query.frameMax, 0x1000),\n    'heartbeat': intOrDefault(query.heartbeat, 0),\n\n    // open\n    'virtualHost': vhost,\n    'capabilities': '',\n    'insist': 0\n  };\n}\n\n// Decide on credentials based on what we're supplied\nfunction credentialsFromUrl(parts) {\n  var user = 'guest', passwd = 'guest';\n  if (parts.auth) {\n    var auth = parts.auth.split(':');\n    user = auth[0];\n    passwd = auth[1];\n  }\n  return credentials.plain(user, passwd);\n}\n\nfunction connect(url, socketOptions, openCallback) {\n  // tls.connect uses `util._extend()` on the options given it, which\n  // copies only properties mentioned in `Object.keys()`, when\n  // processing the options. So I have to make copies too, rather\n  // than using `Object.create()`.\n  var sockopts = clone(socketOptions || {});\n  url = url || 'amqp://localhost';\n\n  var noDelay = !!sockopts.noDelay;\n  var timeout = sockopts.timeout;\n  var keepAlive = !!sockopts.keepAlive;\n  // 0 is default for node\n  var keepAliveDelay = sockopts.keepAliveDelay || 0;\n\n  var extraClientProperties = sockopts.clientProperties || {};\n\n  var protocol, fields;\n  if (typeof url === 'object') {\n    protocol = (url.protocol || 'amqp') + ':';\n    sockopts.host = url.hostname;\n    sockopts.port = url.port || ((protocol === 'amqp:') ? 5672 : 5671);\n\n    var user, pass;\n    if (!url.username) {\n      user = 'guest';\n      pass = url.password || 'guest';\n    } else {\n      user = url.username;\n      pass = url.password;\n    }\n\n    fields = openFrames(url.vhost, null, sockopts.credentials || credentials.plain(user, pass), extraClientProperties);\n  } else {\n    var parts = URL.parse(url, true); // yes, parse the query string\n    protocol = parts.protocol;\n    sockopts.host = parts.hostname;\n    sockopts.port = parseInt(parts.port) || ((protocol === 'amqp:') ? 5672 : 5671);\n    var vhost = parts.pathname ? parts.pathname.substr(1) : null;\n    fields = openFrames(vhost, parts.query, sockopts.credentials || credentialsFromUrl(parts), extraClientProperties);\n  }\n\n  var sockok = false;\n  var sock;\n\n  function onConnect() {\n    sockok = true;\n    sock.setNoDelay(noDelay);\n    if (keepAlive) sock.setKeepAlive(keepAlive, keepAliveDelay);\n\n    var c = new Connection(sock);\n    c.open(fields, function(err, ok) {\n      // disable timeout once the connection is open, we don't want\n      // it fouling things\n      if (timeout) sock.setTimeout(0);\n      if (err === null) {\n        openCallback(null, c);\n      }\n      else openCallback(err);\n    });\n  }\n\n  if (protocol === 'amqp:') {\n    sock = require('net').connect(sockopts, onConnect);\n  }\n  else if (protocol === 'amqps:') {\n    sock = require('tls').connect(sockopts, onConnect);\n  }\n  else {\n    throw new Error(\"Expected amqp: or amqps: as the protocol; got \" + protocol);\n  }\n\n  if (timeout) {\n    sock.setTimeout(\n      timeout, openCallback.bind(this, new Error('connect ETIMEDOUT')));\n  }\n\n  sock.once('error', function(err) {\n    if (!sockok) openCallback(err);\n  });\n\n}\n\nmodule.exports.connect = connect;\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"script","externalDependencies":[]}